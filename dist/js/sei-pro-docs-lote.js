// var docsLote_specialChars = {"À":"&Agrave;","Á":"&Aacute;","Â":"&Acirc;","Ã":"&Atilde;","Ä":"&Auml;","Å":"&Aring;","à":"&agrave;","á":"&aacute;","â":"&acirc;","ã":"&atilde;","ä":"&auml;","å":"&aring;","Æ":"&AElig;","æ":"&aelig;","ß":"&szlig;","Ç":"&Ccedil;","ç":"&ccedil;","È":"&Egrave;","É":"&Eacute;","Ê":"&Ecirc;","Ë":"&Euml;","è":"&egrave;","é":"&eacute;","ê":"&ecirc;","ë":"&euml;","ƒ":"&#131;","Ì":"&Igrave;","Í":"&Iacute;","Î":"&Icirc;","Ï":"&Iuml;","ì":"&igrave;","í":"&iacute;","î":"&icirc;","ï":"&iuml;","Ñ":"&Ntilde;","ñ":"&ntilde;","Ò":"&Ograve;","Ó":"&Oacute;","Ô":"&Ocirc;","Õ":"&Otilde;","Ö":"&Ouml;","ò":"&ograve;","ó":"&oacute;","ô":"&ocirc;","õ":"&otilde;","ö":"&ouml;","Ø":"&Oslash;","ø":"&oslash;","Œ":"&#140;","œ":"&#156;","Š":"&#138;","š":"&#154;","Ù":"&Ugrave;","Ú":"&Uacute;","Û":"&Ucirc;","Ü":"&Uuml;","ù":"&ugrave;","ú":"&uacute;","û":"&ucirc;","ü":"&uuml;","µ":"&#181;","×":"&#215;","Ý":"&Yacute;","Ÿ":"&#159;","ý":"&yacute;","ÿ":"&yuml;","°":"&#176;","º":"&#176;","†":"&#134;","‡":"&#135;","±":"&#177;","«":"&#171;","»":"&#187;","¿":"&#191;","¡":"&#161;","·":"&#183;","•":"&#149;","™":"&#153;","©":"&copy;","®":"&reg;","§":"&#167;","¶":"&#182;"};
var docsLote_specialChars = {"\u00C0":"&Agrave;","\u00C1":"&Aacute;","\u00C2":"&Acirc;","\u00C3":"&Atilde;","\u00C4":"&Auml;","\u00C5":"&Aring;","\u00E0":"&agrave;","\u00E1":"&aacute;","\u00E2":"&acirc;","\u00E3":"&atilde;","\u00E4":"&auml;","\u00E5":"&aring;","\u00C6":"&AElig;","\u00E6":"&aelig;","\u00DF":"&szlig;","\u00C7":"&Ccedil;","\u00E7":"&ccedil;","\u00C8":"&Egrave;","\u00C9":"&Eacute;","\u00CA":"&Ecirc;","\u00CB":"&Euml;","\u00E8":"&egrave;","\u00E9":"&eacute;","\u00EA":"&ecirc;","\u00EB":"&euml;","\u0192":"&#131;","\u00CC":"&Igrave;","\u00CD":"&Iacute;","\u00CE":"&Icirc;","\u00CF":"&Iuml;","\u00EC":"&igrave;","\u00ED":"&iacute;","\u00EE":"&icirc;","\u00EF":"&iuml;","\u00D1":"&Ntilde;","\u00F1":"&ntilde;","\u00D2":"&Ograve;","\u00D3":"&Oacute;","\u00D4":"&Ocirc;","\u00D5":"&Otilde;","\u00D6":"&Ouml;","\u00F2":"&ograve;","\u00F3":"&oacute;","\u00F4":"&ocirc;","\u00F5":"&otilde;","\u00F6":"&ouml;","\u00D8":"&Oslash;","\u00F8":"&oslash;","\u0152":"&#140;","\u0153":"&#156;","\u0160":"&#138;","\u0161":"&#154;","\u00D9":"&Ugrave;","\u00DA":"&Uacute;","\u00DB":"&Ucirc;","\u00DC":"&Uuml;","\u00F9":"&ugrave;","\u00FA":"&uacute;","\u00FB":"&ucirc;","\u00FC":"&uuml;","\u00B5":"&#181;","\u00D7":"&#215;","\u00DD":"&Yacute;","\u0178":"&#159;","\u00FD":"&yacute;","\u00FF":"&yuml;","\u00B0":"&#176;","\u00BA":"&#176;","\u2020":"&#134;","\u2021":"&#135;","\u00B1":"&#177;","\u00AB":"&#171;","\u00BB":"&#187;","\u00BF":"&#191;","\u00A1":"&#161;","\u00B7":"&#183;","\u2022":"&#149;","\u2122":"&#153;","\u00A9":"&copy;","\u00AE":"&reg;","\u00A7":"&#167;","\u00B6":"&#182;"};
var docsLote_normalChars_utf8 = {"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","Æ":"_","æ":"_","ß":"B","Ç":"C","ç":"c","È":"E","É":"E","Ê":"E","Ë":"E","è":"e","é":"e","ê":"e","ë":"e","ƒ":"f","Ì":"I","Í":"I","Î":"I","Ï":"I","ì":"i","í":"i","î":"i","ï":"i","Ñ":"N","ñ":"n","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","Ø":"_","ø":"_","Œ":"_","œ":"_","Š":"S","š":"S","Ù":"U","Ú":"U","Û":"U","Ü":"U","ù":"u","ú":"u","û":"u","ü":"u","µ":"u","×":"_","Ý":"Y","Ÿ":"Y","ý":"y","ÿ":"y","°":"","º":"","†":"_","‡":"_","±":"_","«":"_","»":"_","¿":"_","¡":"_","·":"_","•":"_","™":"_","©":"_","®":"_","§":"_","¶":"_"};
var docsLote_normalChars_iso = {"\u00C0":"A","\u00C1":"A","\u00C2":"A","\u00C3":"A","\u00C4":"A","\u00C5":"A","\u00E0":"a","\u00E1":"a","\u00E2":"a","\u00E3":"a","\u00E4":"a","\u00E5":"a","\u00C6":"_","\u00E6":"_","\u00DF":"B","\u00C7":"C","\u00E7":"c","\u00C8":"E","\u00C9":"E","\u00CA":"E","\u00CB":"E","\u00E8":"e","\u00E9":"e","\u00EA":"e","\u00EB":"e","\u0192":"f","\u00CC":"I","\u00CD":"I","\u00CE":"I","\u00CF":"I","\u00EC":"i","\u00ED":"i","\u00EE":"i","\u00EF":"i","\u00D1":"N","\u00F1":"n","\u00D2":"O","\u00D3":"O","\u00D4":"O","\u00D5":"O","\u00D6":"O","\u00F2":"o","\u00F3":"o","\u00F4":"o","\u00F5":"o","\u00F6":"o","\u00D8":"_","\u00F8":"_","\u0152":"_","\u0153":"_","\u0160":"S","\u0161":"S","\u00D9":"U","\u00DA":"U","\u00DB":"U","\u00DC":"U","\u00F9":"u","\u00FA":"u","\u00FB":"u","\u00FC":"u","\u00B5":"u","\u00D7":"_","\u00DD":"Y","\u0178":"Y","\u00FD":"y","\u00FF":"y","\u00B0":"","\u00BA":"","\u2020":"_","\u2021":"_","\u00B1":"_","\u00AB":"_","\u00BB":"_","\u00BF":"_","\u00A1":"_","\u00B7":"_","\u2022":"_","\u2122":"_","\u00A9":"_","\u00AE":"_","\u00A7":"_","\u00B6":"_"};
var CSVEnconding = 'utf-8';
var dynamicFields = [];
var CSVData = [];
var CSVHeaders = [];
var dataCrossing = []
var selectedModel = {};
var CSVFileName = '';
var docsNames = '';
var aborted = false;
var flagError = false;
var flagConfirmSpecialChars = false;
var forceNames = false;
var pageHelp = typeof URLPAGES_SPRO !== 'undefined' ? `${URLPAGES_SPRO}/pages/DOCUMENTOSEMLOTE.html` : false;
var docsCriados = [];
var listTxtPadraoDoc = [];

var docsLote_getDocsArvore = (optionBlank = false, disableId = false) => {
    getDocsArvore(
        $('#docLoteSelect'), 
        function(select, optionBlank, disableId) {
            getDocsArvore_fillSelect(select, optionBlank, disableId);
        }, 
        function() {
            // $("#btnSelecaoDoc").prop('disabled', false).removeClass('ui-button-disabled ui-state-disabled');
        }, 
        optionBlank, 
        disableId
    );
}
var docsLote_docAnalysis = async (protocolo, nrTxtPadrao) => {
    $('#fieldList').remove();
    dynamicFields = [];

    if (!$('#loaderAnalysis')[0]) { //So o loader renderiza se ja nao existir
        $('#dialogBoxDocLote').append(`<div id='loaderAnalysis' style='height: 40px; text-align: center; display: block;'><i class="fas fa-spinner fa-spin azulColor" style="scale:3;"></i></div>`);
        $("#btnConfirmAnalysis").prop('disabled', true).addClass('ui-button-disabled ui-state-disabled'); //Desabilita Botao OK ate o carregamento
    }

    const selectedDoc = protocolo? dataDocs.find((doc) => doc.id_documento.toString() === protocolo.toString()) : false;
    const selectedTxtPadrao = nrTxtPadrao? listTxtPadraoDoc.find((txtPadrao) => txtPadrao.id.toString() === nrTxtPadrao.toString()) : false;

    if (selectedTxtPadrao) {
        $.get(selectedTxtPadrao.view).done((contentTxtPadrao) => {
            selectedTxtPadrao.nome = selectedTxtPadrao.name;
            selectedTxtPadrao.numero = selectedTxtPadrao.id;
            const body = $(contentTxtPadrao).find('#txaConteudo').text();
            const matches = Array.from(new Set(body.match(/##.+?##/gm)));//rearranjo para remover duplicatas
            docsLote_fillModelAnalysis(matches, selectedTxtPadrao, true);
        }).then(() => {
            $("#loaderAnalysis").remove();
        });
    } else {
        $.get(selectedDoc.src).done((contentDoc) => {
            const body = contentDoc.substring(contentDoc.indexOf('<body>'), contentDoc.lastIndexOf('</body>'));
            const matches = Array.from(new Set(body.match(/##.+?##/gm)));//rearranjo para remover duplicatas
            docsLote_fillModelAnalysis(matches, selectedDoc);
        }).then(() => {
            $("#loaderAnalysis").remove();
        });
    }
}
var docsLote_fillModelAnalysis = async (matches, selectedDoc, txtModelo = false) => {
    selectedModel = selectedDoc;
    dynamicFields = matches.map((field) => field.trim());

    $('#dialogBoxDocLote').append(`<div id='fieldList'></div>`);
    $('#fieldList').append(`<p class="textAnalysis"><i class='fas fa-${txtModelo ? 'keyboard' : 'file-alt'} cinzaColor'></i> ${txtModelo ? 'Texto Padr\u00E3o' : 'Documento'} : ${selectedDoc.nome}</p>`)
    if (txtModelo) {
        $("#btnConfirmAnalysis").prop('disabled', true).addClass('ui-button-disabled ui-state-disabled');
        
        const tiposDocumentos = await getTypeSEI('documentos');
        const selectTiposDocumentos = tiposDocumentos ? $.map(tiposDocumentos, function(v){ return '<option value="'+v.id+'">'+v.name+'</option>' }).join('') : false;

        $('#fieldList').append(`
            <p class="textAnalysis">
                <i class='fas fa-file-alt cinzaColor'></i> Tipo de Documento:
            </p>
            <p class="textAnalysis">
                <select style="width:300px" id="tipoDocumentoSelect"><option value="">Selecione um tipo de documento</option>${selectTiposDocumentos}</select>
            </p>
            `);
        
        $('#tipoDocumentoSelect').chosen({
            placeholder_text_single: ' ', 
            no_results_text: 'Nenhum resultado encontrado',
            normalize_search_text: function(text) {
                return removeAcentos(text.toLowerCase());
            }
        });
        $('#tipoDocumentoSelect').on('change', function() {
            const id_tipo_documento = $('#tipoDocumentoSelect').val();
            const tipoDocumento = tiposDocumentos.find((tipo) => tipo.id === id_tipo_documento);
            if (tipoDocumento) {
                selectedModel.nome = tipoDocumento.name;
                selectedModel.id_tipo_documento = id_tipo_documento;
                $("#btnConfirmAnalysis").prop('disabled', false).removeClass('ui-button-disabled ui-state-disabled');
            } else {
                $("#btnConfirmAnalysis").prop('disabled', true).addClass('ui-button-disabled ui-state-disabled');
            }
        });
    }
    if (matches.length) {

        let lista = `<ul class="textAnalysis" style="max-height: 250px;overflow-y: auto;">\n`;
        matches.forEach((field) => {
            lista += `<li>${field.replaceAll('#', '')}</li>\n`
        })
        lista += '</ul>';
        $('#fieldList').append(`<p class="textAnalysis dFielTitle"><i class='fas fa-hashtag cinzaColor'></i> Campos din\u00E2micos detectados:</p>`)
        $('#fieldList').append(lista);
        if (!txtModelo) $("#btnConfirmAnalysis").prop('disabled', false).removeClass('ui-button-disabled ui-state-disabled');
    } else {
        $('#fieldList').append(`<small class="noFieldsError">N\u00E3o foi identificado nenhum campo din\u00E2mico no documento modelo informado. Verifique se os mesmos foram redigidos corretamente com o padr\u00E3o ##nome do campo##.</small>`)
    }
    centralizeDialogBox(dialogBoxPro);

}

var docsLote_detectEncodingCSV = () => {
    $("#inputBD").on("change", function () {
        const file = $(this)[0].files[0];
        const reader = new FileReader();
        reader.onload = function (e) {
            let csvResult = e.target.result.split(/\r|\n|\r\n/);
                CSVEnconding = jschardet.detect(csvResult.toString()).encoding.toLowerCase();
            // $("#inputBD").attr('encoding', CSVEnconding);
            // console.log('encoding', CSVEnconding);
        }
        reader.readAsBinaryString(file);
    });
}

var docsLote_CSVAnalysis = (file) => {
    $('#fieldListCSV').remove();
    //So renderiza se ja nno existir
    if (!$('#loaderAnalysisCSV')[0]) $('#dialogBoxDocLote').append(`<div id='loaderAnalysisCSV' style='height: 40px; text-align: center; display: block;'><i class="fas fa-spinner fa-spin azulColor" style="scale:3;"></i></div>`);

    Papa.parse(file, {
        header: true,
        skipEmptyLines: "greedy",
        encoding: CSVEnconding,
        // encoding: $("#inputBD").attr('encoding') === "utf-8" ? "utf-8" : "windows-1252",
        complete: (results) => {
            docsLote_fillCSVAnalysis(results, file.name);
            $("#loaderAnalysisCSV").remove();
            centralizeDialogBox(dialogBoxPro);
        }
    });
}

var docsLote_fillCSVAnalysis = (parseData, filename) => {
    CSVFileName = filename;
    CSVData = parseData.data;
    if (typeof CSVData[0] !== 'undefined' && CSVData[0] !== null) {
        CSVHeaders = Object.keys(CSVData[0]).filter(Boolean); // Rearranjo para remover cabecalhos vazios

        $('#dialogBoxDocLote').append(`<div id='fieldListCSV'></div>`)
        $('#fieldListCSV').append(`<p class="textAnalysis"><i class='fas fa-file-csv azulColor'></i> Arquivo: ${filename}</p>`)
        if (CSVHeaders.length) {
            let lista = `<ul class="textAnalysis" style="max-height: 250px;overflow-y: auto;">\n`;
                CSVHeaders.forEach((field) => {
                    lista += `<li>${field}</li>\n`
                });
                lista += '</ul>';
            $('#fieldListCSV').append(`
                <p class="textAnalysis dFielTitle"><i class='fas fa-layer-group cinzaColor'></i> Quantidade de registros: ${CSVData.length}</p>
                <p class="textAnalysis dFielTitle"><i class='fas fa-hashtag cinzaColor'></i> Cabe\u00E7alhos detectados:</p>
                ${lista}`);
            $("#btnConfirmAnalysis").prop('disabled', false).removeClass('ui-button-disabled ui-state-disabled');
        } else {
            docsLote_printFieldError();
        }
    } else {
        docsLote_printFieldError();
    }
}

var docsLote_printFieldError = () => {
    $('#dialogBoxDocLote').append(`<p class="noFieldsError"><i class="fas fa-exclamation-triangle vermelhoColor"></i> N\u00E3o foi identificado nenhum cabe\u00E7alho no arquivo enviado. <br><br>\uD83E\uDD14 Verifique se a planilha n\u00E3o est\u00E1 vazia.</p>`);
    $("#btnConfirmAnalysis").prop('disabled', true).addClass('ui-button-disabled ui-state-disabled');
}
var docsLote_printDataCrossing = async () => {
    dataCrossing = [];
    const cleanFields = dynamicFields.map((field) => field.replaceAll('#', ''));
        CSVHeaders.forEach((header) => {
            try {
                const matchedDynamicField = cleanFields.find((field) => field === header);
                if (matchedDynamicField) dataCrossing.push(header)
            } catch {
                return
            }
        });

    if (!dataCrossing[0]) {
        $('#dialogBoxDocLote').html(`<p class="noFieldsError"><i class="fas fa-exclamation-triangle vermelhoColor"></i> N\u00E3o existe correspond\u00EAncia no arquivo CSV informado!</p>`);
        $("#btnConfirm").prop('disabled', true).addClass('ui-button-disabled ui-state-disabled');
    } else {
        let tbody = '';
            dataCrossing.forEach((data) => {
                tbody +=    `<tr>
                                <td style="padding-left: 10px;">${data}</td>
                                <td style="text-align:center;"><i class='fas fa-arrow-right azulColor'></i></td>
                                <td>##${data}##</td>
                            </tr>`;
            });

        let selectData = '';
            CSVHeaders.forEach(header => { selectData += `<option>${header}</option>` });

        const tiposProcessos = await getTypeSEI('processos');
        const selectTiposProcessos = tiposProcessos ? $.map(tiposProcessos, function(v){ return '<option value="'+v.id+'">'+v.name+'</option>' }).join('') : false;


        $('#dialogBoxDocLote').append(`
            <div id="divTableDataCrossing">
                <div style="max-height: 300px;overflow-y: auto;">
                    <table id="tableDataCrossing" style="font-size: 9pt !important;width: 100%;" class="seiProForm tableInfo tableZebra tableFollow">
                        <thead>
                            <th class="tituloControle" style="width: 47%;">${CSVFileName}</th>
                            <th class="tituloControle"></th>
                            <th class="tituloControle" style="width: 47%;">${selectedModel.nome}</th>
                        </thead>
                        <tbody>
                            ${tbody}
                        </tbody>
                    </table>
                </div>
                <hr style="all:revert;border: 1px solid #dcdcdc;margin: 10px 0;">
                <table style="font-size: 9pt !important;width: 100%;">
                    <tbody>
                        ${
                            !isNewSEI ?
                            `
                            <tr>
                                <td colspan="2">
                                    <p style="font-size: 1.2em;"><i class='fas fa-file-alt cinzaColor'></i> Nome do documento na \u00E1rvore de processos <a class="newLink" style="font-size: 0.8em;" onmouseout="return infraTooltipOcultar();" onmouseover="return infraTooltipMostrar(\'Alguns documentos possuem a propriedade <b>N\u00FAmero</b> que quando preenchida exibe o valor na \u00E1rvore de processos logo ap\u00F3s o tipo. Exemplo: Anexo Contrato (Anexo = tipo e Contrato = N\u00FAmero)\')"><i class="fas fa-info-circle azulColor"></i></a></p>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <select id="nomesDoc">${selectData}</select>
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 50px;">
                                    <div class="divInputForceNames" style="margin: 10px 0; font-size: 9pt;transform: scale(0.9);">
                                        <div class="onoffswitch" style="float: left;margin-right: 1em;">
                                        <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="checkForceNames" data-type="setdate" tabindex="0">
                                        <label class="onoff-switch-label" for="checkForceNames"></label>
                                    </div>
                                </td>
                                <td>
                                    <label for="checkForceNames">For\u00E7ar atribui\u00E7\u00E3o de nomes na \u00C1rvore (Pode gerar erros \uD83D\uDC80)</label>
                                </td>
                            </tr>
                            `
                            : isNewSEI ?
                            `
                            <tr>
                                <td>
                                    <div style="margin: 10px 0;display: inline-block;">
                                    <p style="font-size: 1.2em;">Nome do documento na \u00E1rvore de processos <a class="newLink" style="font-size: 0.8em;" onmouseout="return infraTooltipOcultar();" onmouseover="return infraTooltipMostrar(\'Somente alguns tipos de documentos suportam a propriedade <b>N\u00FAmero</b> que quando preenchida exibe o valor na \u00E1rvore de processos logo ap\u00F3s o tipo. Exemplo: Anexo Contrato (Anexo = tipo e Contrato = N\u00FAmero)\')"><i class="fas fa-info-circle colorAzul"></i></a></p>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <select id="nomesDoc">${selectData}</select>
                                </td>
                            </tr>
                            ` : 
                            ""
                        }
                    </tbody>
                </table>
                <hr style="all:revert;border: 1px solid #dcdcdc;margin: 10px 0;">
                <table style="font-size: 9pt !important;width: 100%;">
                    <tbody>
                        <tr>
                            <td style="width: 50px;">
                                <div style="margin: 10px 0;font-size: 9pt;display: inline-block;transform: scale(0.9);float: left;">
                                    <div class="onoffswitch" style="float: left;margin-right: 1em;margin-left: 0;">
                                        <input type="checkbox" onchange="changeNewProcs(this)" name="onoffswitch" class="onoffswitch-checkbox" id="newProcs" data-type="setdate" tabindex="0">
                                        <label class="onoff-switch-label" for="newProcs"></label>
                                    </div>
                                </div>
                            </td>
                            <td>     
                                <label for="newProcs">Criar cada documento em um novo processo</label>
                            </td>
                        </tr>
                        <tr style="display:none" class="containerTipoProcessoSelect">
                            <td colspan="2">
                                <p style="font-size: 1.2em;"><i class="fas fa-folder-open cinzaColor"></i> Tipo de Processo:</p>
                                <select onchange="checkTipoProcessoSelect()" id="tipoProcessoSelect"><option value="">Selecione um tipo de documento</option>${selectTiposProcessos}</select>
                            </td>
                        </tr>
                        <tr style="display:none" class="containerTipoProcessoSelect">
                            <td colspan="2">
                                <p style="font-size: 1.2em;"><i class="fas fa-comment-dots cinzaColor"></i> Especifica\u00E7\u00E3o do processo: (Dispon\u00EDvel campos din\u00E2micos da planilha)</p>
                                <input type="text" class="infraText" id="txtEspecificacaoProcesso" style="width: 480px;padding: 0.8em;" placeholder="Ex: Certificado de ##nome_aluno##">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            `);
            $('#nomesDoc').chosen({
                placeholder_text_single: ' ', 
                no_results_text: 'Nenhum resultado encontrado',
                normalize_search_text: function(text) {
                    return removeAcentos(text.toLowerCase());
                }
            });
            $('#tipoProcessoSelect').chosen({
                placeholder_text_single: ' ', 
                no_results_text: 'Nenhum resultado encontrado',
                normalize_search_text: function(text) {
                    return removeAcentos(text.toLowerCase());
                }
            });    
            $('#tipoProcessoSelect_chosen').css('width', '500px');

    }
    setTimeout(() => {
        centralizeDialogBox(dialogBoxPro);
    }, 300);
    setTimeout(() => {
        $('#dialogBoxPro').removeAttr('style');
    }, 500);
}

var changeNewProcs = async (this_) => {
    if ($(this_).is(':checked')) {
        $('.containerTipoProcessoSelect').show();
        checkTipoProcessoSelect();
    } else {
        $('.containerTipoProcessoSelect').hide();
        $("#btnConfirm").prop('disabled', false).removeClass('ui-button-disabled ui-state-disabled');
    }
};

var checkTipoProcessoSelect = () => {
    if ($('#tipoProcessoSelect').val() && $('#tipoProcessoSelect').val() != 'null') {
        $("#btnConfirm").prop('disabled', false).removeClass('ui-button-disabled ui-state-disabled');
    } else {
        $("#btnConfirm").prop('disabled', true).addClass('ui-button-disabled ui-state-disabled');
    }
}
var docsLote_getLinkNewDoc = async (param, dataCSV) => {
    let urlNewDoc = false;
    if (param.createNewProcs) {

        const txtEspecificacaoProcesso = param.txtEspecificacaoProcesso.replace(/##(.*?)##/g, function(match, chave) {
            return dataCSV[chave] !== undefined ? dataCSV[chave] : match;
        });

        const urlProcesso = await docsLote_setNewProc(param.idTipoProcedimento, txtEspecificacaoProcesso);
        if (urlProcesso) {
            urlNewDoc = await docsLote_getUrlNewDoc(urlProcesso);
        }
    } else {
        urlNewDoc = getUrlNewDocArvore();
    }
    return urlNewDoc;
}
var docsLote_execute = async (param) => {
    aborted = false;

    if (!param.createNewProcs && !getUrlNewDocArvore()) {
        flagError = true;
        alertaBoxPro('Error', 'exclamation-triangle', 'Erro ao localizar o link de inserir documento. Verifique se o processo encontra-se aberto em sua unidade!');
    } else {
        if (!isNewSEI) {
            forceNames = param.forceNames;
            let docsLote_normalChars = CSVEnconding == 'utf-8' ? docsLote_normalChars_utf8 : docsLote_normalChars_iso;
            const regex = new RegExp(Object.keys(docsLote_normalChars).join('|'));
            const hasSpecialChars = CSVData.some(data => data[param.docsNames].match(regex))
            if (hasSpecialChars) {
                const confirmSpecialChars = confirm(`
                Os nomes escolhidos para constar na \u00E1rvore de processos cont\u00E9m caracteres especiais.

                O ideal \u00E9 que n\u00E3o possuam.Portanto, \u00E9 poss\u00EDvel que ocorram alguns problemas de formata\u00E7\u00E3o.

                Deseja continuar ?
                `)
                if (!confirmSpecialChars) {
                    docLoteModalCruzamentoDados(param.nrDoc, param.csvFile, param.nrTxtPadrao);
                    flagConfirmSpecialChars = true;
                    return;
                }
            }
        }

        for (let i = 0; i < CSVData.length; i++) {
            try {
                const urlNewDoc = await docsLote_getLinkNewDoc(param, CSVData[i]);
                const response1 = await docsLote_clickNewDoc(urlNewDoc);
                const response2 = await docsLote_selectDocType(response1.urlExpandDocList);
                const response3 = await docsLote_formNewDoc(response2.urlFormNewDoc, CSVData[i], param);
                const response4 = await docsLote_confirmDocData(response3.urlConfirmDocData, response3.params);
                const response5 = await docsLote_editDocContent(response4.urlEditor, CSVData[i]);
                const response6 = await docsLote_saveDoc(response5.urlSubmitForm, response5.paramsSaveDoc);

                response6.success && $('#progress').html(`<p style="text-align:center">${i + 1}/${CSVData.length}<span style="display:block;white-space: nowrap;color: #ccc;font-size: 8pt;padding:5px">\u2592\u2592\u2592\u2592\u2592\u2592</span></p>`);

                if (i + 1 === CSVData.length) throw new Error("cancel");

            } catch (e) {
                if (e.message && e.message === "cancel") {
                    $('#ifrArvore').contents()[0].location.reload();
                    setTimeout(() => {
                        var htmlFilterDoclote = `<div class="btn-group filterTablePro" role="group" style="margin: 10px 0;">
                                                <button type="button" onclick="downloadTablePro(this)" data-icon="fas fa-download" style="padding: 0.1rem .5rem; font-size: 9pt;" data-value="Baixar" class="btn btn-sm btn-light">
                                                    <i class="fas fa-download" style="padding-right: 3px; cursor: pointer; font-size: 10pt; color: #888;"></i>
                                                    <span class="text">Baixar</span>
                                                </button>
                                                <button type="button" onclick="copyTablePro(this)" data-icon="fas fa-copy" style="padding: 0.1rem .5rem; font-size: 9pt;" data-value="Copiar" class="btn btn-sm btn-light">
                                                    <i class="fas fa-copy" style="padding-right: 3px; cursor: pointer; font-size: 10pt; color: #888;"></i>
                                                    <span class="text">Copiar</span>
                                                </button>
                                            </div>`;

                        var theadRows = '<tr>';
                            theadRows += $.map(Object.keys(docsCriados[0].data_doc),function(k){ return `<th class="tituloControle">${k}</th>` }).join('');
                            theadRows += '   <th class="tituloControle" style="white-space: nowrap;">nome_documento_gerado</th>';
                            theadRows += '   <th class="tituloControle" style="white-space: nowrap;">numero_sei_gerado</th>';
                            theadRows += '   <th class="tituloControle" style="white-space: nowrap;">link_documento_gerado</th>';
                            theadRows += '</tr>';

                        var tbodyRows = $.map(docsCriados, function(v){ 
                                            var _return = '<tr>';
                                                _return += $.map(v.data_doc,function(d){ return `<td style="white-space: nowrap;">${d}</td>` }).join('');
                                                // _return += $.map(v.data_doc,function(d){ return '<td style="white-space: nowrap;">'+decodeURIComponent(escape(d))+'</td>' }).join('');
                                                _return += `   <td style="white-space: nowrap;">${v.nome_documento || ''} ${v.data_doc[param.docsNames] || ''}</td>`;
                                                _return += `   <td style="white-space: nowrap;">${v.nr_sei || ''}</td>`;
                                                _return += `   <td style="white-space: nowrap;"><a href="${v.url_doc || ''}" target="_blank" class="bLink" style="font-size: 9pt;">${v.url_doc || ''}</a></td>`;
                                                _return += '</tr>';
                                            return _return
                                        }).join('');
                        var tableResult = `
                                <div style="max-height: 350px;max-width: 850px;overflow: auto;">
                                    <table id="tableDataResult" style="font-size: 9pt !important;width: 100%;" class="seiProForm tableInfo tableZebra tableFollow">
                                        <thead>
                                            ${theadRows}
                                        </thead>
                                        <tbody>
                                            ${tbodyRows}
                                        </tbody>
                                    </table>
                                </div>
                                `;
                        $('#preparingProgressCircular').remove();
                        $('#cancelExecute').hide();
                        $('#progress').html(`<h4 style="text-align:center;margin: 30px 0 10px 0; font-size: 1.5rem;"><i class="fas fa-check-circle verdeColor" style="font-size: 1em;"></i> Progresso finalizado! \uD83D\uDC4F</h4>${tableResult}`);
                        // setTimeout(() => { resetDialogBoxPro('dialogBoxPro') }, 2000);
                        dialogBoxPro.dialog('option', 'width', 870);
                        dialogBoxPro.dialog('option', 'height', 500);
                        $('#tableDataResult').find('thead').prepend(htmlFilterDoclote);
                        // console.log(docsCriados);
                    }, 500)
                } else {
                    flagError = true;
                    console.log("Erro \uD83D\uDE22 -> ", e);
                    docLoteModalErro();
                }
                aborted = false;
                break;
            }
        }
    }
}

var docsLote_clickNewDoc = async (urlNewDoc) => {
    const htmlChooseDocType = await $.get(urlNewDoc);
    const urlExpandDocList = $(htmlChooseDocType).find('#frmDocumentoEscolherTipo').attr('action');

    if (aborted) throw new Error("cancel");
    if (typeof urlExpandDocList !== 'undefined') $('#progress span').text('\u2588\u2592\u2592\u2592\u2592\u2592');
    return {
        urlExpandDocList,
        success: true
    }
}
var docsLote_selectDocType = async (urlExpandDocList) => {

    const htmlExpandedDocList = await $.ajax({
        method: 'POST',
        url: urlExpandDocList,
        data: { hdnFiltroSerie: 'T' }
    });

    const htmlTypeList = $(htmlExpandedDocList).find('.ancoraOpcao');

    let checkPost = htmlTypeList.attr('href');
        checkPost = typeof checkPost !== 'undefined' && checkPost == '#' ? true : false;


    let urlFormNewDoc = false;

    if (checkPost) {
        urlFormNewDoc = await getSerieForm($(htmlExpandedDocList), null, selectedModel.nome, selectedModel.id_tipo_documento);
    } else {
        let typeList = [];
        for (let i = 0; i < htmlTypeList.length; i++) {
            typeList.push({
                nome: htmlTypeList[i].textContent,
                url: htmlTypeList[i].getAttribute("href")
            });
        }
        typeList.some((type) => {
            if (selectedModel.nome.startsWith(type.nome)) {
                urlFormNewDoc = type.url;
                return true;
            }
        });
    }
    if (aborted) throw new Error("cancel");
    if (urlFormNewDoc) $('#progress span').text('\u2588\u2588\u2592\u2592\u2592\u2592');
    return {
        urlFormNewDoc,
        success: true
    };
}
var docsLote_formNewDoc = async (urlFormNewDoc, data, dataDialog) => {
    const htmlFormNewDoc = await $.get(urlFormNewDoc);
    const form = $(htmlFormNewDoc).find('#frmDocumentoCadastro')
    const urlConfirmDocData = form.attr('action');
    const numeroOpcional = form.find("#lblNumero").attr('class') === 'infraLabelOpcional';
    const nomeOpcional = form.find("#lblNomeArvore").attr('class') === 'infraLabelOpcional';
    let docsLote_normalChars = CSVEnconding == 'utf-8' ? docsLote_normalChars_utf8 : docsLote_normalChars_iso;

    let params = {};
    form.find("input[type=hidden]").each(function () {
        if ($(this).attr('name') && $(this).attr('id').includes('hdn')) {
            params[$(this).attr('name')] = $(this).val();
        }
    });
    form.find('input[type=text]').each(function () {
        if ($(this).attr('id') && $(this).attr('id').includes('txt')) {
            params[$(this).attr('id')] = $(this).val();
        }
    });
    form.find('select').each(function () {
        if ($(this).attr('id') && $(this).attr('id').includes('sel')) {
            params[$(this).attr('id')] = $(this).val();
        }
    });
    form.find('input[type=radio]').each(function () {
        if ($(this).attr('name') && $(this).attr('name').includes('rdo')) {
            params[$(this).attr('name')] = $(this).val();
        }
    });
    params.rdoNivelAcesso = '0';
    params.hdnFlagDocumentoCadastro = '2';
    params.txaObservacoes = '';
    params.txtDescricao = '';
    if (dataDialog.nrTxtPadrao) {
        params.selTextoPadrao = selectedModel.numero;
    } else {
        params.txtProtocoloDocumentoTextoBase = selectedModel.numero;
    }

    const regex = new RegExp(Object.keys(docsLote_normalChars).join('|'), 'g');
    // let nomeArvore = forceNames ? data[dataDialog.docsNames].replace(regex, (match) => docsLote_normalChars[match]).substring(0, 50) : data[dataDialog.docsNames].substring(0, 50);
    let nomeArvore = removeAcentos(data[dataDialog.docsNames].substring(0, 50)).trim();

    if (!numeroOpcional || forceNames) {
        params.txtNumero = nomeArvore;
    } else {
        params.txtNumero = '';
    }
    params.txtNomeArvore = (nomeOpcional && isNewSEI) ? decodeURIComponent(escape(nomeArvore)) : '';
    
    if (aborted) throw new Error("cancel");
    if (typeof urlConfirmDocData !== 'undefined') $('#progress span').text('\u2588\u2588\u2588\u2592\u2592\u2592');

    return {
        urlConfirmDocData,
        params,
        success: true
    };
}
var docsLote_confirmDocData = async (urlConfirmDocData, params) => {

    var postData = '';
    for (var k in params) {
        if (postData !== '') postData = `${postData}&`;
        var valor = (k=='txtNomeArvore') ? escapeComponent(params[k]) : params[k];
            postData = `${postData}${k}=${valor}`;
    }

    const htmlDocCreated = await $.ajax({
        method: 'POST',
        url: urlConfirmDocData,
        // data: params,
        data: postData,
        contentType: 'application/x-www-form-urlencoded; charset=ISO-8859-1'
    });

    let urlEditor = false;
    var searchLinkEditor = htmlDocCreated.match(/controlador\.php\?acao=editor_montar&id_procedimento=[^'"]*/);
    if (searchLinkEditor) urlEditor = searchLinkEditor[0];
    else throw new Error('Link de edi\u00E7\u00E3o n\u00E3o encontrado');

    if (aborted) throw new Error("cancel");
    if (urlEditor) $('#progress span').text('\u2588\u2588\u2588\u2588\u2592\u2592');
    else throw new Error('Link de edi\u00E7\u00E3o n\u00E3o encontrado');

    return {
        urlEditor,
        success: true
    };
}
var docsLote_editDocContent = async (urlEditor, data) => {
    const htmlEditor = await $.get(urlEditor);  //TODO: Lançar exceção, identificar e excluir o doc gerado erroneamente
    const urlSubmitForm = $(htmlEditor).filter((_, el) => $(el).attr('id') === 'frmEditor').attr('action');
    const urlParams = getParamsUrlPro(urlEditor);
    const docTitle = trycatch(() => htmlEditor.match(/<title[^>]*>([^<]+)<\/title>/)[1], false);
    const nrSEI = docTitle ? docTitle.split('-')[1].trim() : false;
    const nomeDocumento = docTitle ? docTitle.split('-')[2].trim() : false;

    const textAreas = $(htmlEditor).find('div#divEditores textarea');
    const allText = $.map(textAreas, function(v){ return $(v).text() }).join('');
    const arrayCamposDinamicos = uniqPro(getHashTagsPro($(allText).map(function(){ return $(this).text().replace(/\u00A0/gm, " ") }).get().join(' ')));
    const dadosProcesso = typeof dadosProcessoPro !== 'undefined' && typeof dadosProcessoPro.propProcesso !== 'undefined' 
        ? camposDinamicosProcesso(arrayCamposDinamicos) 
        : false;
    const regex1 = new RegExp(dataCrossing.map((data) => `##${data}##`).join('|'), 'g');
    const regex2 = new RegExp(Object.keys(docsLote_specialChars).join('|'), 'g');
    const regex3 = new RegExp(arrayCamposDinamicos.map((data) => `#${data}`).join('|'), 'g');
    
    let textAreasReplaced = textAreas.map((_, el) =>
        $(el).text().replace(regex1, (match) =>
            data[match.substring(2, match.length - 2)].replace(regex2, (match) => docsLote_specialChars[match])
        )
    );
    /* if (dadosProcesso && arrayCamposDinamicos.length) {
        textAreasReplaced = textAreas.map((_, el) =>
        $(el).text().replace(regex3, (match) =>dadosProcesso[match.substring(1, match.length)])
        );
    } */

    let paramsSaveDoc = {};
    textAreasReplaced.each((i, textArea) => {
        paramsSaveDoc[$(textAreas).eq(i).attr('name')] = textArea;
    });
    // console.log({data:data, dataCrossing: dataCrossing, docsLote_specialChars:docsLote_specialChars, arrayCamposDinamicos:arrayCamposDinamicos, textAreasReplaced:textAreasReplaced, textAreas:textAreas, arrayCamposDinamicos:arrayCamposDinamicos, dadosProcesso:dadosProcesso});

    $(htmlEditor).find('input[type=hidden').each((_, input) => {
        if (!$(input).attr('name').toLowerCase().includes('unidade'))
        paramsSaveDoc[$(input).attr('name')] = $(input).val().replace(regex2, (match) => docsLote_specialChars[match]);
    });

    if (aborted) throw new Error("cancel");
    if (typeof urlSubmitForm !== 'undefined') $('#progress span').text('\u2588\u2588\u2588\u2588\u2588\u2592');

    docsCriados.push({
        nr_sei: nrSEI, 
        id_documento: urlParams.id_documento, 
        id_procedimento: urlParams.id_procedimento, 
        data_doc: data,
        nome_documento: nomeDocumento,
        url_doc: `${url_host}?acao=procedimento_trabalhar&id_procedimento=${urlParams.id_procedimento}&id_documento=${urlParams.id_documento}`
    });

    return {
        urlSubmitForm,
        paramsSaveDoc,
        success: true,
        nrSEI: nrSEI
    }

}
var docsLote_saveDoc = async (urlSubmitForm, paramsSaveDoc) => {
    const responseSave = await $.ajax({
        method: 'POST',
        url: urlSubmitForm,
        data: paramsSaveDoc,
    });
    if (aborted) throw new Error("cancel");
    
    if (responseSave.startsWith("OK")) {
        if (typeof urlSubmitForm !== 'undefined') $('#progress span').text('\u2588\u2588\u2588\u2588\u2588\u2588');
        return { success: true }
    } else {
        throw new Error(responseSave);
    }
}
var docsLote_abortAjax = () => {
    if (!flagError && !flagConfirmSpecialChars) {
        aborted = true;
        $('#cancelExecute').hide();
        $('#progress').html(`<p style="text-align:center">Cancelando progresso</p>`);
    } else {
        flagError = false;
        flagConfirmSpecialChars = false;
        aborted = false;
    }
}
function docLoteModalSelecaoDoc() {
    const urlNewDoc = getUrlNewDocArvore();
    if (!urlNewDoc) {
        flagError = true;
        alertaBoxPro('Error', 'exclamation-triangle', 'Erro ao localizar o link de inserir documento. Verifique se o processo encontra-se aberto em sua unidade!');
    } else {
        var htmlBox = `<table style="font-size: 10pt;width: 100%;" class="seiProForm">
                        <tr>
                            <td style="vertical-align: top;text-align: left;height: 40px;" class="label">
                                <label for="docLoteSelect"><i class="iconPopup iconSwitch fas fa-file-alt cinzaColor"></i> Selecione abaixo, dentre os documentos constantes na \u00E1rvore do processo, o modelo para reprodu\u00E7\u00E3o em lote:</label>
                            </td>
                        </tr>
                        <tr>
                            <td class="required">
                                <select id="docLoteSelect"><option><i class="fas fa-sync fa-spin cinzaColor"></i> carregando dados... </option></select>
                            </td>
                        </tr>
                        <tr>
                            <td style="vertical-align: bottom;text-align: left;height: 40px;" class="label">
                                <label for="textoPadraoSelect"><i class="iconPopup iconSwitch fas fa-keyboard cinzaColor"></i> ou Selecione do Texto Padr\u00E3o da Unidade:</label>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <select id="textoPadraoSelect"><option><i class="fas fa-sync fa-spin cinzaColor"></i> carregando dados... </option></select>
                            </td>
                        </tr>
                    </table>
                    ${restrictConfigValue('documentosemlote') ? '<div style="margin: 10px 0;font-size: 8pt;color: #888;">C\u00F3digo-fonte gentilmente cedido por <a href="https://github.com/tcgontijo" target="_blank" style="color: #00c;">tcgontijo</a> | PluriDocs SEI!<div>' : ''}`;

        resetDialogBoxPro('dialogBoxPro');
        dialogBoxPro = $('#dialogBoxPro')
            .html(`<div id="dialogBoxDocLote" class="dialogBoxDiv">${htmlBox}</div>`)
            .dialog({
                title: 'Documento modelo - Sele\u00E7\u00E3o (1/6)',
                    width: 600,
                    open: () => {
                        if (typeof URL_SPRO !== 'undefined' && typeof jschardet === 'undefined') $.getScript(`${URL_SPRO}js/lib/jschardet.min.js`); 
                        if (typeof URL_SPRO !== 'undefined' && typeof Papa === 'undefined') $.getScript(`${URL_SPRO}js/lib/papaparse.js`);
                        $("#btnSelecaoDoc").prop('disabled', true).addClass('ui-button-disabled ui-state-disabled');
                        $('#docLoteSelect')
                            .on('change', () => {
                                $('#textoPadraoSelect').val('').trigger('chosen:updated');
                                $("#btnSelecaoDoc").prop('disabled', false).removeClass('ui-button-disabled ui-state-disabled');
                            })
                            .chosen({
                                placeholder_text_single: ' ', 
                                no_results_text: 'Nenhum resultado encontrado',
                                normalize_search_text: function(text) {
                                    return removeAcentos(text.toLowerCase());
                                }
                            });
                        $('#textoPadraoSelect').chosen({
                            placeholder_text_single: ' ', 
                            no_results_text: 'Nenhum resultado encontrado',
                            normalize_search_text: function(text) {
                                return removeAcentos(text.toLowerCase());
                            }
                        });
                        docsLote_getDocsArvore(true);
                        docsCriados = [];
                        $('#textoPadraoSelect')
                            .on('change', () => {
                                $('#docLoteSelect').val('').trigger('chosen:updated');
                                $("#btnSelecaoDoc").prop('disabled', false).removeClass('ui-button-disabled ui-state-disabled');
                            })
                            .html('<option value="">&nbsp;</option>');
                        txtPadrao_getList().then(listTxtPadrao => {
                            listTxtPadraoDoc = listTxtPadrao;
                            $('#textoPadraoSelect').append(listTxtPadrao.map(item => `<option value="${item.id}">${item.name}</option>`).join(''));
                            $('#textoPadraoSelect').trigger('chosen:updated');
                        });
                    },
                    buttons: [{
                        text: "Ajuda",
                        icon: 'ui-icon-help',
                        click: function () {
                            window.open(pageHelp);
                        }
                    },{
                        id: 'btnSelecaoDoc',
                        text: "Avan\u00E7ar",
                        icon: 'ui-icon-arrowthick-1-e',
                        class: 'confirm ui-state-active',
                        click: function () {
                            if ($(this).find('small')[0]) {
                                resetDialogBoxPro('dialogBoxPro');
                            } else {
                                const nrDoc = $('#docLoteSelect').find('option:selected').data('id_documento');
                                const nrTxtPadrao = $('#textoPadraoSelect').val();
                                docLoteModalAnaliseDocModelo(nrDoc, nrTxtPadrao);
                            }
                        }
                    }]
        });
    }
}

var docLoteModalSelecaoBaseDados = (nrDoc, csvFile, nrTxtPadrao) => {
    var htmlBox = `<table style="font-size: 10pt;width: 100%;" class="seiProForm">
                    <tr>
                        <td style="vertical-align: top;text-align: left;height: 40px;" class="label">
                            <label for="inputBD"><i class="iconPopup iconSwitch fas fa-upload cinzaColor"></i>Selecione um arquivo no formato CSV para servir como base de dados para a gera\u00E7\u00E3o de documentos em lote:</label>
                        </td>
                    </tr>
                    <tr>
                        <td class="required">
                            <input id="inputBD" type="file" accept=".csv, text/csv"></input>
                        </td>
                    </tr>
                </table>`;

    resetDialogBoxPro('dialogBoxPro');
    dialogBoxPro = $('#dialogBoxPro')
        .html(`<div id="dialogBoxDocLote" class="dialogBoxDiv">${htmlBox}</div>`)
        .dialog({
            title: 'Base de dados - Upload (3/6)',
            width: 600,
            open: () => {
                docsLote_detectEncodingCSV();
                $("#btnEnviaCSV").prop('disabled', true).addClass('ui-button-disabled ui-state-disabled');
                $("#inputBD").change(() => {
                    $("#btnEnviaCSV").prop('disabled', false).removeClass('ui-button-disabled ui-state-disabled');
                });
            },
            buttons: [{
                text: "Ajuda",
                icon: 'ui-icon-help',
                click: function () {
                    window.open(pageHelp);
                }
            },{
                text: "Voltar",
                icon: 'ui-icon-arrowthick-1-w',
                click: function () {
                    docLoteModalAnaliseDocModelo(nrDoc, nrTxtPadrao);
                }
            },{
                id: 'btnEnviaCSV',
                text: "Avan\u00E7ar",
                disabled: true,
                icon: 'ui-icon-arrowthick-1-e',
                class: 'confirm ui-state-active',
                click: () => {
                    $('#baseDados small').remove();
                    const file = $("#inputBD")[0].files[0];
                    
                    if (file.name.substring(file.name.lastIndexOf("."), file.name.length).toLocaleLowerCase().trim() === ".csv") {
                        docLoteModalAnaliseCSV(nrDoc, $("#inputBD")[0].files[0], nrTxtPadrao);
                    } else {
                        $('#inputBD').after(`<small class="noFieldsError">Arquivo inv\u00E1lido! Selecione um documento no formato "CSV".</small>`);
                    }
                }
            }]
        });
}

var docLoteModalLoader = (paramData) => {
    var htmlBox =   `<div style="margin-top: 35px;" id="preparingProgressCircular">
                        <div style='height: 40px; text-align: center; display: block;'><i class="fas fa-spinner fa-spin azulColor" style="scale:3;"></i></div>
                    </div>
                    <div id="progress">
                        <p style="text-align:center" id="preparingProgress">Preparando ambiente</p>
                    </div>`;

    resetDialogBoxPro('dialogBoxPro');
    dialogBoxPro = $('#dialogBoxPro')
        .html(`<div id="dialogBoxDocLote" class="dialogBoxDiv">${htmlBox}</div>`)
        .dialog({
            title: 'Documentos em lote - Criando (6/6)',
            width: 300,
            open: () => {
                docsLote_execute(paramData);
            },
            close: () => {
                docsLote_abortAjax();
            },
            buttons: [{
                text: "Cancelar",
                id: 'cancelExecute',
                icon: 'ui-icon-cancel',
                click: function () {
                    docsLote_abortAjax();
                }
            }]
    });
}

var docLoteModalErro = (textError = false) => {
    var htmlBox =   `<div>
                        <p><i class="fas fa-exclamation-triangle vermelhoColor"></i> Eita! Algo deu errado na replica\u00E7\u00E3o de documentos \uD83D\uDE14</p>
                        <br>
                        <p>Verifique as configura\u00E7\u00F5es selecionadas e tente novamente.</p>
                        <p>${textError}</p>
                    </div>`;

    resetDialogBoxPro('dialogBoxPro');
    dialogBoxPro = $('#dialogBoxPro')
        .html(`<div id="dialogBoxDocLote" class="dialogBoxDiv">${htmlBox}</div>`)
        .dialog({
            title: '\uD83E\uDD26\u200D\u2642\uFE0F Ops...',
            width: 600,
            buttons: [{
                text: "OK",
                class: 'ui-state-active',
                click: function () {
                    resetDialogBoxPro('dialogBoxPro');
                }
            }]
    });
}

var docLoteModalCruzamentoDados = (nrDoc, csvFile, nrTxtPadrao) => {
    var htmlBox = `<p>Segue abaixo o relacionamento entre cabe\u00E7alhos da base de dados e os campos din\u00E2micos do documento modelo:</p>`;

    resetDialogBoxPro('dialogBoxPro');
    dialogBoxPro = $('#dialogBoxPro')
        .html(`<div id="dialogBoxDocLote" class="dialogBoxDiv">${htmlBox}</div>`)
        .dialog({
            title: 'Cruzamento de dado (5/6)',
            width: 600,
            maxHeight: (window.innerHeight * 0.9),
            open: () => docsLote_printDataCrossing(),
            buttons: [{
                text: "Ajuda",
                icon: 'ui-icon-help',
                click: function () {
                    window.open(pageHelp);
                }
            },{
                text: "Voltar",
                icon: 'ui-icon-arrowthick-1-w',
                click: function () {
                    docLoteModalSelecaoBaseDados(nrDoc, csvFile, nrTxtPadrao);
                }
            },{
                id: 'btnConfirm',
                text: "Iniciar",
                icon: 'ui-icon-play',
                class: 'confirm ui-state-active',
                click: function () {
                    var paramData = {
                        docsNames: $('#nomesDoc').val(),
                        forceNames: $("#checkForceNames").is(":checked"),
                        createNewProcs: $("#newProcs").is(":checked"),
                        idTipoProcedimento: $('#tipoProcessoSelect').val(),
                        txtEspecificacaoProcesso: $('#txtEspecificacaoProcesso').val(),
                        nrDoc: nrDoc,
                        csvFile: csvFile,
                        nrTxtPadrao: nrTxtPadrao
                    };
                    docLoteModalLoader(paramData);
                }
            }]
    });
}

var docLoteModalAnaliseDocModelo = (nrDoc, nrTxtPadrao) => {
    var htmlBox = `<p>An\u00E1lise do documento modelo:</p>`;

    resetDialogBoxPro('dialogBoxPro');
    dialogBoxPro = $('#dialogBoxPro')
        .html(`<div id="dialogBoxDocLote" class="dialogBoxDiv">${htmlBox}</div>`)
        .dialog({
            title: 'Documento modelo - Campos din\u00E2micos (2/6)',
            width: 600,
            maxHeight: (window.innerHeight * 0.9),
            open: () => {
                docsLote_docAnalysis(nrDoc, nrTxtPadrao);
                setTimeout(() => {
                    $('#dialogBoxPro').removeAttr('style');
                }, 500);
            },
            buttons: [{
                    text: "Ajuda",
                    icon: 'ui-icon-help',
                    click: function () {
                        window.open(pageHelp);
                    }
                }, {
                    text: "Voltar",
                    icon: 'ui-icon-arrowthick-1-w',
                    click: function () {
                        docLoteModalSelecaoDoc();
                    }
                },{
                    id: 'btnConfirmAnalysis',
                    text: "Avan\u00E7ar",
                    icon: 'ui-icon-arrowthick-1-e',
                    class: 'confirm ui-state-active',
                    click: function () {
                        docLoteModalSelecaoBaseDados(nrDoc, null, nrTxtPadrao);
                    }
                },
            ]
    });
}

var docLoteModalAnaliseCSV = (nrDoc, csvFile, nrTxtPadrao) => {
    var htmlBox = `<p>An\u00E1lise da base de dados:</p>`;

    resetDialogBoxPro('dialogBoxPro');
    dialogBoxPro = $('#dialogBoxPro')
        .html(`<div id="dialogBoxDocLote" class="dialogBoxDiv">${htmlBox}</div>`)
        .dialog({
            title: 'Base de dados - Cabe\u00E7alhos e registros (4/6)',
            width: 600,
            open: () => {
                docsLote_CSVAnalysis(csvFile);
            },
            buttons: [{
                text: "Ajuda",
                icon: 'ui-icon-help',
                click: function () {
                    window.open(pageHelp);
                }
            },{
                text: "Voltar",
                icon: 'ui-icon-arrowthick-1-w',
                click: function () {
                    docLoteModalSelecaoBaseDados(nrDoc, csvFile, nrTxtPadrao);
                }
            },{
                id: 'btnConfirmAnalysisCSV',
                text: "Avan\u00E7ar",
                icon: 'ui-icon-arrowthick-1-e',
                class: 'confirm ui-state-active',
                click: function () {
                    docLoteModalCruzamentoDados(nrDoc, csvFile, nrTxtPadrao);
                }
            }]
    });
}

// Função assíncrona para obter a URL inicial do procedimento
const getInitialProcUrl = async () => {
    const urlInitProc = $(`${mainMenu} a[href*="acao=procedimento_escolher_tipo"]`).attr('href');
    if (!urlInitProc) {
        throw new Error('Erro ao iniciar a criação do processo');
    }
    return urlInitProc;
};

// Função assíncrona para obter o HTML inicial do procedimento
const getInitialProcHtml = async (urlInitProc) => {
    const htmlInitProc = await $.ajax({ url: urlInitProc });
    return $(htmlInitProc);
};

// Função assíncrona para obter a lista completa de tipos de procedimento
const getFullProcList = async (htmlInitProc) => {
    const form = isSEI_5 ? htmlInitProc.find('#frmProcedimentoEscolherTipo') : htmlInitProc.find('#frmIniciarProcessoEscolhaTipo');
    const hrefForm = form.attr('action');
    
    const param = {};
    form.find("input[type=hidden]").each(function () {
        if ($(this).attr('name') && $(this).attr('id').indexOf('hdn') !== -1) {
            param[$(this).attr('name')] = $(this).val();
        }
    });
    param.hdnFiltroTipoProcedimento = 'T';

    const htmlFullList = await $.ajax({
        method: 'POST',
        data: param,
        url: hrefForm
    });
    
    return $(htmlFullList);
};

// Função assíncrona para obter o formulário do procedimento específico
const getProcForm = async (htmlFullList, id_tipo_procedimento) => {
    let urlProc = htmlFullList.find(`a[href*="procedimento_escolher_tipo&id_tipo_procedimento=${id_tipo_procedimento}"]`).attr('href');

    let checkPost = htmlFullList.find('#tblTipoProcedimento').find('a.ancoraOpcao').attr('href');
        checkPost = typeof checkPost !== 'undefined' && checkPost == '#' ? true : false;

    if (checkPost) {
        urlProc = await getSerieForm(htmlFullList, id_tipo_procedimento);
    }

    if (!urlProc) {
        throw new Error('Erro ao selecionar o tipo de processo. Verifique se o tipo est\u00E1 dispon\u00EDvel no sistema e tente novamente');
    }
    
    const htmlFormProc = await $.ajax({ url: urlProc });
    return $(htmlFormProc);
};

const getSerieForm = async (htmlFullList, id_tipo_procedimento, nameDoc = null, id_tipo_documento = null) => {
    const urlForm = !nameDoc ? htmlFullList.find('#frmProcedimentoEscolherTipo') : htmlFullList.find('#frmDocumentoEscolherTipo');
    const param = {};
        urlForm.find("input[type=hidden]").each(function () {
            if ( $(this).attr('name') && $(this).attr('id').indexOf('hdn') !== -1) {
                param[$(this).attr('name')] = $(this).val(); 
            }
        });
        
        if (id_tipo_documento) {
            param.hdnIdSerie = id_tipo_documento;
        } else if (nameDoc) {
            let hdnIdSerie = false; 

            urlForm.find('input.infraCheckbox').each(function(){
                if ($(this).attr('title').startsWith(nameDoc)) {
                    hdnIdSerie = $(this).val();
                    return false;
                }
            });

            if (!hdnIdSerie) {
                throw new Error('Erro ao selecionar o tipo de documento. Verifique se o tipo est\u00E1 dispon\u00EDvel no sistema e tente novamente');
            }

            param.hdnIdSerie = hdnIdSerie; 
        } else { param.hdnIdTipoProcedimento = id_tipo_procedimento; }

    const xhr = new XMLHttpRequest();
    const htmlSerieForm = await $.ajax({ 
        method: 'POST',
        data: param,
        url: urlForm.attr('action'),
        contentType: 'application/x-www-form-urlencoded; charset=ISO-8859-1',
        xhr: function() {
            return xhr;
        },
    });
    return xhr.responseURL;
};
// Função para extrair parâmetros do formulário
const extractFormParams = (form) => {
    const param = {};
    
    // Inputs hidden
    form.find("input[type=hidden]").each(function () {
        if ($(this).attr('name') && $(this).attr('id').indexOf('hdn') !== -1) {
            param[$(this).attr('name')] = $(this).val();
        }
    });
    
    // Inputs de texto
    form.find('input[type=text]').each(function () {
        if ($(this).attr('id') && $(this).attr('id').indexOf('txt') !== -1) {
            param[$(this).attr('id')] = $(this).val();
        }
    });
    
    // Selects
    form.find('select').each(function () {
        if ($(this).attr('id') && $(this).attr('id').indexOf('sel') !== -1) {
            param[$(this).attr('id')] = $(this).val();
        }
    });
    
    // Inputs radio
    form.find('input[type=radio]').each(function () {
        if ($(this).attr('name') && $(this).attr('name').indexOf('rdo') !== -1) {
            param[$(this).attr('name')] = $(this).val();
        }
    });
    
    return param;
};

// Função para preparar dados do formulário
const prepareFormData = (param, htmlFormProc, txtEspecificacaoProcesso) => {
    // Configurações padrão
    param.rdoNivelAcesso = '0';
    param.hdnFlagProcedimentoCadastro = '2';
    param.rdoProtocolo = 'M';
    param.txaObservacoes = '';
    param.txtDescricao = txtEspecificacaoProcesso ? txtEspecificacaoProcesso.substring(0, 100).trim() : '';
    // Assuntos
    param.hdnAssuntos = (htmlFormProc.find('#selAssuntos option').length === 0) 
        ? [] 
        : htmlFormProc.find('#selAssuntos option')
            .map(function() { 
                return $(this).val() + '\u00B1' + $(this).text(); 
            })
            .get()
            .join('\u00A5')
            .replaceAll(' ', '+');
    
    // Interessados
    param.hdnInteressados = htmlFormProc.find('#selInteressados option')
        .map(function() { 
            return $(this).val() + '\u00B1' + $(this).text(); 
        })
        .get()
        .join('\u00A5')
        .replaceAll(' ', '+');

    // Converter para string de dados
    let postData = '';
    for (const [key, value] of Object.entries(param)) {
        if (postData !== '') postData += '&';
        let valor = value;
        
        if (key === 'hdnNomeTipoProcedimento' || key === 'hdnAssuntos' || key === 'txtDescricao') {
            valor = escapeComponent(value);
        }
        
        postData += `${key}=${valor}`;
    }
    return postData;
};

// Função assíncrona para criar o procedimento
const createProc = async (hrefForm, postData) => {
    const xhr = new XMLHttpRequest();
    const htmlResult = await $.ajax({
        method: 'POST',
        data: postData,
        url: hrefForm,
        contentType: 'application/x-www-form-urlencoded; charset=ISO-8859-1',
        xhr: function() {
            return xhr;
        },
    });
    
    return { htmlResult, xhr };
};

// Função para extrair ID do procedimento criado
const extractProcId = (htmlResult) => {
    const $htmlResult = $(htmlResult);
    const linkProc = $htmlResult.find('#ifrArvore').attr('src');
    
    if (!linkProc) return false;
    
    const id_procedimento = getParamsUrlPro(linkProc).id_procedimento;
    return (typeof id_procedimento !== 'undefined') ? id_procedimento : false;
};

// Função principal assíncrona
const docsLote_setNewProc = async (id_tipo_procedimento, txtEspecificacaoProcesso) => {
    try {
        // 1. Obter URL inicial
        const urlInitProc = await getInitialProcUrl();
        
        // 2. Obter HTML inicial
        const htmlInitProc = await getInitialProcHtml(urlInitProc);
        
        // 3. Obter lista completa de tipos
        const htmlFullList = await getFullProcList(htmlInitProc);
        
        // 4. Obter formulário do procedimento específico
        const htmlFormProc = await getProcForm(htmlFullList, id_tipo_procedimento);
        
        // 5. Extrair parâmetros do formulário
        const form = htmlFormProc.find('#frmProcedimentoCadastro');
        const hrefForm = form.attr('action');
        const param = extractFormParams(form);
        
        // 6. Preparar dados do formulário
        const postData = prepareFormData(param, htmlFormProc, txtEspecificacaoProcesso);
        
        // 7. Criar procedimento
        const { htmlResult, xhr } = await createProc(hrefForm, postData);
        
        // 8. Verificar sucesso e extrair ID
        const status = xhr.responseURL.indexOf('controlador.php?acao=procedimento_trabalhar&acao_origem=procedimento_gerar') !== -1;
        
        if (status) {
            const id_procedimento = extractProcId(htmlResult);
            
            if (id_procedimento) {
                const href = url_host.replace('controlador.php', '') + 
                           `controlador.php?acao=procedimento_trabalhar&id_procedimento=${String(id_procedimento)}`;
                return href;
            } else {
                alertaBoxPro('Error', 'exclamation-triangle', 
                    'N\u00E3o foi poss\u00EDvel abrir o processo gerado. Verifique na caixa de entrada de sua unidade');
                return null;
            }
        }
        
    } catch (error) {
        console.error('Erro na cria\u00E7\u00E3o do procedimento:', error);
        alertaBoxPro('Error', 'exclamation-triangle', error.message);
        return null;
    }

};

// Função assíncrona para obter o HTML do processo
const getProcessHtml = async (urlProcesso) => {
    const html = await $.ajax({ url: urlProcesso });
    return $(html);
};

// Função assíncrona para obter a URL da árvore do processo
const getTreeUrl = (html) => {
    const urlArvore = html.find("#ifrArvore").attr('src');
    if (!urlArvore) {
        throw new Error('Erro ao obter a URL da u00E1rvore do processo');
    }
    return urlArvore;
};

// Função assíncrona para obter o HTML da árvore
const getTreeHtml = async (urlArvore) => {
    const htmlArvore = await $.ajax({ url: urlArvore });
    return htmlArvore;
};

// Função para extrair a URL de novo documento usando regex
const extractNewDocUrl = (htmlArvore) => {
    const regex = /controlador\.php\?acao=documento_escolher_tipo&acao_origem=arvore_visualizar[^"]*/;
    const resultado = htmlArvore.match(regex);
    
    if (!resultado) {
        throw new Error('Erro ao encontrar o link de novo documento');
    }
    
    return resultado[0];
};

// Função principal assíncrona para obter URL de novo documento
const docsLote_getUrlNewDoc = async (urlProcesso) => {
    try {
        // 1. Obter HTML do processo
        const html = await getProcessHtml(urlProcesso);
        
        // 2. Obter URL da árvore
        const urlArvore = getTreeUrl(html);
        
        // 3. Obter HTML da árvore
        const htmlArvore = await getTreeHtml(urlArvore);
        
        // 4. Extrair URL de novo documento
        const urlNewDoc = extractNewDocUrl(htmlArvore);
        
        return urlNewDoc;
        
    } catch (error) {
        console.error('Erro ao obter URL de novo documento:', error);
        alertaBoxPro('Error', 'exclamation-triangle', error.message);
        return null;
    }
};