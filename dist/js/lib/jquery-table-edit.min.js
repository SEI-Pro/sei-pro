// Simple Jquery based table td editor
// https://github.com/unwild/SimpleTableCellEditor/tree/master
var isAssigned=!0;window.onload=function(){if(!window.jQuery)throw"jQuery is not loaded"};class SimpleTableCellEdition{constructor(e,t){this.Elem=e,this.oldContent=$(e).html(),this.oldValue=t.internals.extractValue(e),this.cellParams=t}}class SimpleTableCellEditor{constructor(e,t){var i=this;i.EditionEndOrigin={OutsideTable:1,AnotherCell:2},i.editableClasses=[],this.tableId=e||"table",this.active=!0,this.params=i._GetExtendedEditorParams(t),this.CellEdition=null,this._TryHandleDataTableReloadEvent(),$(document).mouseup(function(e){var t=$(`#${i.tableId}`);t.is(e.target)||0!==t.has(e.target).length||i._FreeCurrentCell(i.EditionEndOrigin.OutsideTable)})}SetEditable(e,t,i="uneditable"){var l=this;if(l._isValidElem(e)){var a=l._GetExtendedCellParams(t);$(e).on("click",function(e){!(!isAssigned||!l.active||$(this).hasClass(l.params.inEditClass)||$(this).hasClass(i))&&($(this).closest("table").hasClass(i)||(isAssigned=!1,l._EditCell(this,a),setTimeout(()=>{isAssigned=!0},100)))}),$(e).on("keydown",function(e){isAssigned&&l.active&&$(this).hasClass(l.params.inEditClass)&&(isAssigned=!1,l._HandleKeyPressed(e,this,a),setTimeout(()=>{isAssigned=!0},100))})}}SetEditableClass(e,t){var i=this,l=i._GetExtendedCellParams(t);i.editableClasses.push(`.${e}`),$(`#${i.tableId}`).on("click",`td.${e}:not(.${i.params.inEditClass})`,function(){isAssigned&&i.active&&(isAssigned=!1,i._EditCell(this,l),setTimeout(()=>{isAssigned=!0},100))}),$(`#${i.tableId}`).on("keydown",`td.${e}.${i.params.inEditClass}`,function(e){isAssigned&&i.active&&(isAssigned=!1,i._HandleKeyPressed(e,this,l),setTimeout(()=>{isAssigned=!0},100))})}Toggle(e){void 0===e&&(e=!this.active),this.active=e}_HandleKeyPressed(e,t,i){var l=e.which,a=e.shiftKey,s=$(t).closest("td").index();$(t).closest("tr").index();var n=!1,d=!1,r=!1,o=!1;if((this.params.navigation&&0!==this.editableClasses.length||"table"==this.tableId)&&(i.behaviour.arrowKeyCauseCursorMove&&a&&(39===l?n=!0:37===l?d=!0:40===l?r=!0:38===l&&(o=!0)),i.behaviour.tabKeyCauseCursorMove&&9===l&&(a?d=!0:n=!0),n||d||r||o)){if(e.preventDefault(),"table"==this.tableId)var h,E=$(t).closest("table").find("td");else var E=$(t).closest("table").find(this.editableClasses.join(","));var u=[];$.each(E,function(){$(this).is(":visible")&&u.push(this)});var C=$(u),c=C.index($(t));if(n)++c===C.length&&(c=0);else if(d)--c<0&&(c=C.length-1);else if(r||o){var v=[];$.each(C,function(){$(this).closest("td").index()===s&&v.push(this)});var b=$(v),m=b.index($(t));r?++m===b.length&&(m=0):o&&--m<0&&(m=b.length-1);var c=C.index($(b[m]))}h=$(C[c]),this._FreeCell(t,i,!0),h.click();return}i.keys.validation.includes(l)?this._FreeCell(t,i,!0):i.keys.cancellation.includes(l)&&this._FreeCell(t,i,!1)}_EditCell(e,t){if(!this._FireOnEditEnterEvent(e).isDefaultPrevented()){this._FreeCurrentCell(this.EditionEndOrigin.AnotherCell),this.CellEdition=new SimpleTableCellEdition(e,t),this.isDataTable&&(this.CellEdition.cellIndex=$(`#${this.tableId}`).DataTable().cell($(e)).index());var i=t.internals.extractValue(e);$(e).addClass(this.params.inEditClass),t.internals.renderEditor(e,i),this._FireOnEditEnteredEvent(e,i)}}_EndEditCell(e,t){this._FreeCell(e,t,!0)}_CancelEditCell(e,t){this._FreeCell(e,t,!1)}_FreeCell(e,t,i){if(this._isValidElem(e)&&null!==this.CellEdition&&!this._FireOnEditExitEvent(e,this.CellEdition.oldValue).isDefaultPrevented()){var l=t.internals.extractEditorValue(e);$(e).removeClass(this.params.inEditClass),$(e).html(""),t.validation(l)&&this.CellEdition.oldValue!==l||(i=!1);var a=t.formatter(l);this._FireOnEditExitedEvent(e,this.CellEdition.oldValue,a,i),i?(t.internals.renderValue(e,a),this._FireEditedEvent(e,this.CellEdition.oldValue,a)):$(e).html(this.CellEdition.oldContent),this.CellEdition=null}}_FreeCurrentCell(e){var t=this._GetCurrentEdition();if(null!==t){var i=!0;e===this.EditionEndOrigin.OutsideTable&&t.cellParams.behaviour.outsideTableClickCauseCancellation&&(i=!1),e===this.EditionEndOrigin.AnotherCell&&t.cellParams.behaviour.anotherCellClickCauseCancellation&&(i=!1),this._FreeCell(t.Elem,t.cellParams,i)}}_GetCurrentEdition(){return null===this.CellEdition?null:this.CellEdition}_GetExtendedEditorParams(e){return $.extend(!0,{},this._GetDefaultEditorParams(),e)}_GetExtendedCellParams(e){return $.extend(!0,{},this._GetDefaultCellParams(),e)}_FireOnEditEnterEvent(e){var t=jQuery.Event("cell:onEditEnter",{element:e});return $(`#${this.tableId}`).trigger(t),t}_FireOnEditEnteredEvent(e,t){$(`#${this.tableId}`).trigger({type:"cell:onEditEntered",element:e,oldValue:t})}_FireOnEditExitEvent(e,t){var i=jQuery.Event("cell:onEditExit",{element:e,oldValue:t});return $(`#${this.tableId}`).trigger(i),i}_FireOnEditExitedEvent(e,t,i,l){$(`#${this.tableId}`).trigger({type:"cell:onEditExited",element:e,newValue:i,oldValue:t,applied:l})}_FireEditedEvent(e,t,i){$(`#${this.tableId}`).trigger({type:"cell:edited",element:e,newValue:i,oldValue:t})}_TryHandleDataTableReloadEvent(){var e=this;this.isDataTable=!1;try{$.fn.DataTable.isDataTable(`#${e.tableId}`)&&(e.isDataTable=!0)}catch(t){return}e.isDataTable&&$(`#${e.tableId}`).on("draw.dt",function(){if(null!==e.CellEdition&&null!==e.CellEdition.Elem){var t=$(`#${e.tableId}`).DataTable().cell(e.CellEdition.cellIndex).node();e._EditCell(t,e.CellEdition.cellParams)}})}_GetDefaultEditorParams(){return{inEditClass:"inEdit",navigation:!0}}_GetDefaultCellParams(){return{validation:e=>!0,formatter:e=>e,keys:{validation:[13],cancellation:[27]},behaviour:{tabKeyCauseCursorMove:!0,arrowKeyCauseCursorMove:!0,outsideTableClickCauseCancellation:!1,anotherCellClickCauseCancellation:!1},internals:this._GetDefaultInternals()}}_GetDefaultInternals(){return{renderValue(e,t){$(e).text(t)},renderEditor(e,t){$(e).html("<input type='text' style=\"width:100%; max-width:none\">");var i=$(e).find("input");i.focus(),i.val(t)},extractEditorValue:e=>$(e).find("input").val(),extractValue:e=>$(e).text()}}_isValidElem(e){return null!=e&&$(e).length>0}}